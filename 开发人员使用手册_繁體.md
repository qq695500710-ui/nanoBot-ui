# 開發者使用手冊（newui.exe + 外置 nanobot-main）

本手冊面向**開發者 / 運維 / 高級使用者**，說明打包後的 `newui.exe` 如何載入同級 `nanobot-main/`、設定路徑、打包態依賴安裝機制、Skills（技能）與 MCP Server 的開發與接入流程。

---

### 1. 發佈包建議結構（關鍵：nanobot-main 可替換更新）

standalone 模式實際分發的是 `newui.dist/`（包含 `newui.exe` 與執行時依賴）。

建議結構：

```
newui.dist/
  newui.exe
  nanobot-main/               # 外置：從 https://github.com/HKUDS/nanobot 下載後放這裡
    nanobot/
    pyproject.toml
    requirements.txt
    ...
  (Nuitka 生成的其它執行時依賴)
```

升級 nanobot（無需重打 newui）：

- 直接用新版官方專案**整包替換** `newui.exe` 同級的 `nanobot-main/`。

---

### 2. 執行時路徑與持久化資料

- **nanobot 主設定**：`%USERPROFILE%\.nanobot\config.json`
- **newui 狀態目錄**：`%USERPROFILE%\.nanobot\newui\`
  - 日誌：`%USERPROFILE%\.nanobot\newui\newui.log`
  - 會話持久化：`%USERPROFILE%\.nanobot\newui\sessions.json`
  - **打包版可寫依賴目錄（vendor site-packages）**：
    - `%USERPROFILE%\.nanobot\newui\vendor\site-packages\`
- **workspace**：`%USERPROFILE%\.nanobot\workspace\`
  - skills：`%USERPROFILE%\.nanobot\workspace\skills\`

---

### 3. newui.exe 如何載入外置 nanobot-main（相容升級的核心）

`newui.exe` 啟動時：

- 優先檢查同級 `nanobot-main\nanobot\cli\commands.py` 是否存在
- 存在則把 `nanobot-main/` 插入 `sys.path` 前部（優先使用外置原始碼）
- 不存在 UI 仍可啟動，但 embedded agent / gateway 相關能力會不可用（錯誤會在日誌顯示）

結論：

- 只要保持 `nanobot-main/` 與 `newui.exe` 同級，就能達到「官方更新 → 直接替換 nanobot-main」。

#### 3.1 LLM 介面設定（交付/運維檢查清單）

在 newui：**設定 → 設定 API Key**，會寫入：

- `providers.<provider>.apiKey`（與可選 `apiBase`）
- `agents.defaults.model`

交付前建議做一次：

- 點 **測試連線**（會送極小請求 “Say OK”）
- 成功後再儲存

常見踩坑：

- 不要把某家的 key 配到另一家的 API Base（例如 DeepSeek key + openrouter base）
- Custom 相容介面通常要 `apiBase` 以 `/v1` 結尾

---

### 4. 打包態依賴安裝機制（只有 newui.exe 的前提）

交付目標是「目標機不要求安裝 Python」。因此依賴補裝只討論打包態：

- 使用打包環境內置 pip（`pip._internal`）
- 透過 `--target` 安裝到：

`%USERPROFILE%\.nanobot\newui\vendor\site-packages\`

並在啟動時插入 `sys.path` 前部，因此：

- 新裝依賴可覆蓋打包內置依賴
- nanobot-main 升級後新增依賴，可讓使用者在 UI 補裝後重啟

---

### 5. 故障診斷（缺模組 / 缺資料檔）

embedded agent 啟動失敗常見兩類：

1) `ModuleNotFoundError: No module named 'xxx'`
   - 引導使用者到 **設定 → 安裝依賴** 補裝 `xxx`，然後重啟

2) 第三方套件資料檔缺失（例如 `endpoints.json`）
   - 重新打包時加 `--include-package-data=<package>`  
   - 或讓使用者在 UI 補裝 `pip install -U <package>` 覆蓋

---

### 6. Skills（技能）開發與接入

#### 6.1 生效位置與優先級

- 生效位置：`%USERPROFILE%\.nanobot\workspace\skills\<skill-name>\SKILL.md`
- 優先級：workspace skills > 內建 builtin skills

#### 6.2 SKILL.md 建議格式（相容 SkillsLoader）

SkillsLoader 的 frontmatter 解析很輕量（逐行 `key: value`），建議用最簡單寫法：

```markdown
---
name: my-skill
description: 在 Windows 上自動化呼叫本機程式（示例）
metadata: '{"nanobot": {"requires": {"bins": [], "env": []}, "always": false}}'
---
```

`metadata.nanobot.requires` 用於 newui「技能管理」顯示可用/不可用：

- `bins`：檢查 `shutil.which()`（例如 `git`、`node`）
- `env`：檢查環境變數是否存在

#### 6.3 只靠 newui.exe 開發技能（不要求 Python）

1) newui → **技能管理 → 打開 skills 目錄**
2) 建立資料夾：`%USERPROFILE%\.nanobot\workspace\skills\<skill-name>\`
3) 放入 `SKILL.md`（用記事本即可）
4) 回到技能管理刷新並預覽
5) 聊天測試：「按技能 <skill-name> 做……」

#### 6.4 範例：呼叫本機 exe 的技能模板

```markdown
---
name: run-local-exe
description: 运行本機 exe/bat，並回傳輸出。
metadata: '{"nanobot": {"requires": {"bins": [], "env": []}, "always": false}}'
---

## 目標
- 使用 exec 工具真正執行程式（不可假裝）
- 回傳退出碼與關鍵輸出

## exec 模板（示例）
- command: `cmd /c \"C:\\\\Tools\\\\MyApp\\\\myapp.exe\" --help`
```

#### 6.5 穩定觸發口令（交付建議）

- 「請**按技能** `<skill-name>` 執行：……」
- 「先讀 `<skill-name>` 的 SKILL.md，再照流程做：……」

---

### 7. MCP Servers 開發與接入（交付場景）

MCP 設定會寫入 `config.json` 的：

- `tools.mcpServers`（相容 `tools.mcp_servers`）

工具命名：

- `mcp_<serverName>_<toolName>`

#### 7.1 newui 的欄位含義

- stdio：
  - `command`：可執行命令（典型：`xxx.exe`、`npx`、`node`）
  - `args`：參數（空格分隔）
  - `env`：環境變數（JSON）
- HTTP：
  - `url`：外部 MCP endpoint

#### 7.2 交付限制（非常重要）

因為目標機不要求安裝 Python：

- **stdio MCP 必須是目標機能直接執行的程式**（最常見是獨立 exe）
- Python 寫的 MCP：
  - 建議打包成 exe（stdio）
  - 或改成 HTTP，把 server 放在伺服器端

#### 7.3 MCP 路線建議（不挑電腦優先）

1) **HTTP MCP（最推薦）**
   - 目標機只要 newui.exe + 網路

2) **stdio MCP（獨立 exe）**
   - 你交付 `my_mcp_server.exe`，newui 的 `command` 指向它

3) **stdio MCP（Node / npx）**
   - 需要目標機安裝 Node.js，適合直接用社群 MCP server

#### 7.4 Python MCP server 示意（僅示例）

```python
from mcp.server.fastmcp import FastMCP

mcp = FastMCP("demo")

@mcp.tool()
def hello(name: str) -> str:
    return f"hello {name}"
```

若要不裝 Python，請把 server 打包成 exe 或改為 HTTP。

#### 7.5 調用與驗證

- newui → **MCP Servers 管理** → 測試連線/列出工具
- 聊天測試：
  - 自然語言：「幫我用 <serverName> 的 <toolName> 做 xxx」
  - 指定工具：「使用工具 `mcp_<serverName>_<toolName>`，參數 `{...}`」

